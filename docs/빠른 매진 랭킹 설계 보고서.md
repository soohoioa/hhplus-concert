# 빠른 매진 랭킹 설계 및 테스트 보고서

## 1. 개요
콘서트 인기도를 정량적으로 판단하기 위한 빠른 매진 랭킹 시스템의 설계 및 테스트 내용이다.

---

## 2. 문제 정의
단순 판매 수량만으로는 인기도를 판단하기 어렵고, 매진까지 걸린 시간을 기준으로 인기도를 측정하는 것이 더 합리적이다.

---

## 3. 설계 목표
- 매진까지 걸린 시간을 기준으로 인기도 산출
- Redis 기반 고성능 랭킹 조회
- 결제 도메인과 자연스럽게 연계

---

## 4. Redis 랭킹 설계

| 목적 | Redis Key | 자료구조 |
|----|----|----|
| 빠른 매진 랭킹 | rank:soldout | ZSET |

### ZSET 구성
- member: scheduleId
- score: (매진 시각 - 오픈 시각) 초 단위
- score가 낮을수록 더 빠른 매진

---

## 5. 랭킹 기록 시점
랭킹은 다음 조건을 만족할 때 기록된다.

1. 결제 성공
2. 좌석 상태가 RESERVED로 변경
3. 해당 스케줄의 AVAILABLE 좌석 수가 0
4. 매진으로 판단 → 랭킹 기록

---

## 6. 도메인 연계
결제(PayService)에서 실판매가 확정되는 시점에 남은 좌석 수를 확인하여 매진 여부를 판단한다.

매진 시 SoldoutRankingService를 통해 Redis ZSET에 기록한다.

---

## 7. 통합 테스트 (PayDistributedLockIT)

### 테스트 목적
- 분산락 환경에서도 결제가 1번만 성공하는지 검증
- 매진 발생 시 랭킹이 정확히 기록되는지 검증

### 테스트 시나리오
1. 좌석 1개짜리 콘서트 생성
2. HOLD 처리
3. 동시에 다수 결제 요청
4. 결제는 1번만 성공
5. 좌석 RESERVED
6. rank:soldout에 기록 확인

### 검증 코드
```java
Double score = redis.opsForZSet()
    .score("rank:soldout", String.valueOf(scheduleId));

assertThat(score).isNotNull();
assertThat(score).isGreaterThanOrEqualTo(0.0);
